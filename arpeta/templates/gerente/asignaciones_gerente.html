{% extends 'gerente/base_gerente.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard de Asignaciones</h1>
    
    <!-- Cards de Resumen -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Card Total Asignaciones -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-blue-500 uppercase tracking-wider">Total de Asignaciones</p>
                    <p class="text-2xl font-bold text-gray-800">{{ total_asignaciones }}</p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Card Asignaciones Activas -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-green-500 uppercase tracking-wider">Asignaciones Activas</p>
                    <p class="text-2xl font-bold text-gray-800">{{ asignaciones_activas }}</p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Card Asignaciones Inactivas -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-yellow-500 uppercase tracking-wider">Asignaciones Inactivas</p>
                    <p class="text-2xl font-bold text-gray-800">{{ asignaciones_inactivas }}</p>
                </div>
                <div class="bg-yellow-100 p-3 rounded-full">
                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Card Material Transportado -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-indigo-500 uppercase tracking-wider">Material Transportado (m³)</p>
                    <p class="text-2xl font-bold text-gray-800">{{ total_material|floatformat:2 }}</p>
                </div>
                <div class="bg-indigo-100 p-3 rounded-full">
                    <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Gráfico de estado de asignaciones -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Distribución de Asignaciones</h2>
            </div>
            <div class="relative h-64">
                <canvas id="estadoAsignacionesChart"></canvas>
            </div>
            <div class="flex justify-center mt-4 space-x-4 text-sm">
                <span class="flex items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> Activas
                </span>
                <span class="flex items-center">
                    <span class="w-3 h-3 bg-yellow-500 rounded-full mr-1"></span> Inactivas
                </span>
            </div>
        </div>

        <!-- Gráfico de material por tipo -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Material Transportado por Tipo</h2>
            </div>
            <div class="relative h-64">
                <canvas id="materialPorTipoChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Gráfico de asignaciones por mes -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-800">Asignaciones por Mes</h2>
        </div>
        <div class="relative h-80">
            <canvas id="asignacionesPorMesChart"></canvas>
        </div>
    </div>

    <!-- Asignaciones Recientes -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">Asignaciones Recientes</h2>
            <div class="flex space-x-2">
                <button id="exportPdfBtn" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                    </svg>
                    Exportar PDF
                </button>
                <a href="{% url 'lista_asignaciones' %}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    Ver Todas
                </a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="dataTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operador</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Asignación</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo Material</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vueltas</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Material</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Vuelta</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for asignacion in asignaciones_recientes %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ asignacion.operador.nombre }} {{ asignacion.operador.apellido }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asignacion.vehiculo.placa }} ({{ asignacion.vehiculo.modelo }})</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asignacion.fecha_asignacion|date:"d/m/Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asignacion.tipo_material.nombre|default:"N/A" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asignacion.total_vueltas }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asignacion.total_material|floatformat:2 }} m³</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if asignacion.estado %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ asignacion.estado_texto }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if asignacion.ultima_vuelta_registrada_en %}
                                {{ asignacion.ultima_vuelta_registrada_en|date:"d/m/Y H:i" }}
                            {% else %}
                                Sin vueltas
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No hay asignaciones recientes</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Librerías requeridas -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
$(document).ready(function() {
    // 1. Gráfico de estado (doughnut)
    const ctxEstado = document.getElementById('estadoAsignacionesChart');
    if (ctxEstado) {
        new Chart(ctxEstado, {
            type: 'doughnut',
            data: {
                labels: ['Activas', 'Inactivas'],
                datasets: [{
                    data: [
                        parseInt('{{ asignaciones_activas|default:0 }}') || 0,
                        parseInt('{{ asignaciones_inactivas|default:0 }}') || 0
                    ],
                    backgroundColor: ['#10B981', '#F59E0B'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.raw;
                            }
                        }
                    }
                }
            }
        });
    }

    // 2. Gráfico de material por tipo (bar)
    const ctxMaterial = document.getElementById('materialPorTipoChart');
    if (ctxMaterial) {
        new Chart(ctxMaterial, {
            type: 'bar',
            data: {
                labels: JSON.parse('{{ tipos_material_labels|escapejs }}'),
                datasets: [{
                    label: 'Material (m³)',
                    data: JSON.parse('{{ tipos_material_data|escapejs }}'),
                    backgroundColor: '#3B82F6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // 3. Gráfico de asignaciones por mes (line)
    const ctxMes = document.getElementById('asignacionesPorMesChart');
    if (ctxMes) {
        new Chart(ctxMes, {
            type: 'line',
            data: {
                labels: JSON.parse('{{ meses_labels|escapejs }}'),
                datasets: [{
                    label: 'Asignaciones',
                    data: JSON.parse('{{ meses_data|escapejs }}'),
                    borderColor: '#3B82F6',
                    tension: 0.3,
                    fill: true,
                    backgroundColor: 'rgba(59, 130, 246, 0.05)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // 4. DataTable
    $('#dataTable').DataTable({
        order: [[2, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.20/i18n/Spanish.json'
        }
    });

    // 5. Exportar a PDF
    $('#exportPdfBtn').click(function() {
        const element = document.getElementById('dataTable').parentNode;
        
        // Crear loader
        const loader = `
            <div id="pdfLoader" class="fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-md shadow-lg flex items-center">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generando PDF...
            </div>
        `;
        $('body').append(loader);

        // Configuración PDF
        const opt = {
            margin: 10,
            filename: 'asignaciones_recientes.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };

        // Generar PDF
        html2pdf().set(opt).from(element).save().then(() => {
            $('#pdfLoader').remove();
            
            // Mostrar notificación de éxito
            const success = `
                <div id="pdfSuccess" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    PDF generado con éxito
                </div>
            `;
            $('body').append(success);
            
            setTimeout(() => $('#pdfSuccess').remove(), 3000);
        });
    });
});
</script>
{% endblock %}